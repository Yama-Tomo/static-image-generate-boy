<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>静止画生成くん</title>
  <style type="text/css">
  body {
    box-sizing: border-box;
    margin: 0.5rem;
    min-width: 500px;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    color: #45515b;
  }

  h1 {
    display: flex;
    align-items: center;
  }

  h1 > span {
    flex: 1;
  }

  h1 img {
    width: 30px;
  }

  .form {
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .files {
    margin-bottom: 1rem;
  }

  textarea {
    width: 100%;
    height: 100px;
    box-sizing: border-box;
  }

  #width, #interval {
    width: 60px;
    margin-top: 0.5rem;
  }

  #to-horizontal {
    margin-top: 0.5rem;
  }

  button {
    cursor: pointer;
    width: 100px;
    height: 30px;
    margin-top: 1rem;
  }

  #list {
    overflow: auto;
  }

  table {
    border: solid 1px #9b9b9b;
    border-collapse: collapse;
  }

  td {
    border: solid 1px #9b9b9b;
  }

  span.title {
    width: 150px;
    overflow-wrap: break-word;
    display: inline-block;
  }

  td.sec {
    text-align: center;
  }

  td.img {
    background-color: #f7f7f7;
    text-align: center;
  }

  table.horizontal {
    writing-mode: vertical-lr;
  }

  table.horizontal td > * {
    writing-mode: horizontal-tb;
  }

  table.horizontal .title {
    width: 250px;
    height: 90px;
  }
  </style>
</head>
<body>
  <h1>
    <span>静止画生成くん</span>
    <a href="https://github.com/Yama-Tomo/static-image-generate-boy" target="_blank">
      <img src='https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'>
    </a>
  </h1>
  <div class="form">
    <div class="files">
      <textarea id="urls" placeholder="ここに動画のURLを入力（複数ある場合は改行区切り）"></textarea>
      <div>ローカルにある動画から生成する場合はここから選択してください</div>
      <input id="local-files" type="file" accept="video/*" multiple />
    </div>
    <div>
      <input type="number" id="interval" value="1" /> 秒ごとに生成
    </div>
    <div>
      <input type="number" id="width" value="300" /> px の横幅で画像を生成
    </div>
    <div>
      <label><input type="checkbox" id="to-horizontal" /> 画像を縦に並べる</label>
    </div>
    <button id='gen-btn'>生成</button>
  </div>
  <div id="indicator"></div>
  <div id="list"></div>
</body>
<script type="text/javascript">
const ele = {
  list: document.getElementById('list'),
  interval: document.getElementById('interval'),
  width: document.getElementById('width'),
  urls: document.getElementById('urls'),
  localFiles: document.getElementById('local-files'),
  indicator: document.getElementById('indicator'),
  button: document.getElementById('gen-btn'),
  toHorizontal: document.getElementById('to-horizontal'),
};

const generateCanvas = (url, title, interval, width, progress) =>
  new Promise((resolve, reject) => {
    try {
      const elements = [];

      const video = document.createElement('video');
      video.src = url;
      video.load();

      video.onseeked = () => {
        const aspectRatio = video.videoHeight / video.videoWidth;
        const canvas = document.createElement('canvas');
        canvas.width = width < video.videoWidth ? width : video.videoWidth ;
        canvas.height = canvas.width * aspectRatio;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.title = `${title} [${video.currentTime.toFixed(1)}sec]`;

        elements.push(canvas);

        if ((video.currentTime + interval) <= video.duration) {
          progress.current += 1;
          ele.indicator.innerText = `Processing.... ${Math.round(progress.current / progress.total * 100)}%`;
          video.currentTime += interval;
        } else {
          // done task
          resolve({ elements, meta: { title } });
        }
      };

      video.onloadeddata = () => {
        video.currentTime = interval;
        progress.total += Math.round(video.duration / interval);
      }

      video.addEventListener('error', reject);
    } catch(e) {
      reject(e);
    }
  });

const onGenerateClick = () => {
  const files = ele.urls.value.trim().split('\n').filter(Boolean).map(url => ({ url, title: url }));
  if (ele.localFiles.files.length) {
    files.push(...Array.from(ele.localFiles.files).map(file => ({ url: URL.createObjectURL(file), title: file.name })));
  }

  const width = ele.width.value ? Number(ele.width.value) : null;
  const interval = ele.interval.value ? Number(ele.interval.value) : null;
  if (!files.length || !width || !interval) {
    return;
  }

  ele.indicator.innerText = 'Processing....';

  const progress = { current: 0, total: 0 };
  const tasks = files.map(file => generateCanvas(file.url, file.title, interval, width, progress));
  Promise.all(tasks).then(results => {
    ele.indicator.innerText = '';

    const itemNum = results.length;
    const cols = Math.max(...results.map(result => result.elements.length));

    while (list.firstChild) {
      list.removeChild(list.firstChild);
    }

    const table = document.createElement('table');

    const tr = table.insertRow(-1);
    tr.insertCell(-1); // 空の td
    for (let colIdx = 0; colIdx < cols; colIdx++) {
      const span = document.createElement('span');
      span.innerText = `${((colIdx + 1) * interval).toFixed(1)}sec`;
      const td = tr.insertCell(-1);
      td.classList.add('sec');
      td.appendChild(span);
    }

    for (let itemIdx = 0; itemIdx < itemNum; itemIdx++) {
      const tr = table.insertRow(-1);

      const span = document.createElement('span');
      span.classList.add('title');
      span.innerText = results[itemIdx].meta.title;
      const fileNameTd = tr.insertCell(-1);
      fileNameTd.appendChild(span);

      for (let colIdx = 0; colIdx < cols; colIdx++) {
        const canvas = results[itemIdx].elements[colIdx];
        const td = tr.insertCell(-1);
        td.classList.add('img');
        td.appendChild(canvas || document.createElement('span'));
      }
    }

    list.appendChild(table);

    setTableStyle(table, ele.toHorizontal.checked);
  }).catch(err => {
    console.error(err);
    ele.indicator.innerText = `エラーが発生しました`;
  });
};

ele.button.addEventListener('click', onGenerateClick);
ele.toHorizontal.addEventListener('change', (e) => {
  const table = ele.list.querySelector('table');
  if (!table) {
    return;
  }

  setTableStyle(table, e.target.checked);
});


const setTableStyle = (table, isHorizontal) => {
  if (isHorizontal) {
    table.classList.add('horizontal');
    return;
  }

  table.classList.remove('horizontal');
};
</script>
</html>
